--=============================================================================
-- SECTION 8 : TRIGGER : VÉRIFICATION DE LA PRÉSENCE DU JOUEUR DANS LE MATCH
-- =============================================================================
-- L'objectif est de vérifier que lorsqu'on insère des statistiques pour un joueur 
-- Dans un match donné, ce joueur avait bien un contrat actif avec l'une des
-- deux équipes à la date exacte du match.

--Ajouter la colonne obligatoire Game_Date à la table game
ALTER TABLE game
ADD COLUMN Game_Date DATE NOT NULL;

CREATE OR REPLACE FUNCTION trg_check_player_in_game_fn()
RETURNS TRIGGER AS $$
DECLARE
    v_id_team_1 INT;
    v_id_team_2 INT;
    v_game_date DATE;
    v_contract_count INT;
BEGIN
    -- Étape 1 : Récupérer les deux équipes et la date du match en une seule requête.
    SELECT
        gt.ID_Team_1,
        gt.ID_Team_2,
        g.Game_Date
    INTO
        v_id_team_1,
        v_id_team_2,
        v_game_date
    FROM Game g
    JOIN Game_Teams gt ON g.ID_Game = gt.ID_Game
    WHERE g.ID_Game = NEW.ID_Game;

    -- Étape 2 : Vérifier si le joueur (NEW.ID_Player) avait un contrat actif
    -- avec l'une des deux équipes à la date du match.
    -- Un contrat est "actif" si la date du match est comprise entre
    -- la Start_Date et la End_Date du contrat.
    -- Si End_Date est NULL, le contrat est toujours en cours et donc valide.
    SELECT COUNT(*)
    INTO v_contract_count
    FROM Historic_Player
    WHERE
        ID_Player = NEW.ID_Player
        AND (ID_Team = v_id_team_1 OR ID_Team = v_id_team_2)
        AND Start_Date <= v_game_date
        AND (End_Date >= v_game_date OR End_Date IS NULL);

    -- Étape 3 : Si aucun contrat actif n'est trouvé, refuser l'insertion.
    IF v_contract_count = 0 THEN
        RAISE EXCEPTION 'Le joueur (ID: %) n''avait pas de contrat actif avec l''équipe 1 (ID: %) ou l''équipe 2 (ID: %) à la date du match (%). Impossible d''ajouter les statistiques.',
        NEW.ID_Player, v_id_team_1, v_id_team_2, v_game_date;
    END IF;

    -- Si la vérification passe, l'opération (INSERT ou UPDATE) est autorisée.
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Application du trigger sur la table des statistiques de jeu.
CREATE TRIGGER trg_check_player_in_game
BEFORE INSERT OR UPDATE ON Player_Game_Stats
FOR EACH ROW
EXECUTE FUNCTION trg_check_player_in_game_fn();
